<%- include('../partials/header', { title: pageName }) %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-user me-2"></i><%= pageName %></h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="/hub">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/hub/users">Admin Users</a></li>
            <li class="breadcrumb-item active">Details</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-6">
          <!-- User Info -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-info-circle me-2"></i>User Information</h3>
            </div>
            <div class="card-body">
              <form id="updateUserForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">First Name</label>
                      <input type="text" class="form-control" name="firstName" value="<%= adminUser.firstName || '' %>">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Last Name</label>
                      <input type="text" class="form-control" name="lastName" value="<%= adminUser.lastName || '' %>">
                    </div>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" value="<%= adminUser.email %>" readonly>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-control" name="status">
                    <option value="active" <%= adminUser.status === 'active' ? 'selected' : '' %>>Active</option>
                    <option value="inactive" <%= adminUser.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                    <option value="suspended" <%= adminUser.status === 'suspended' ? 'selected' : '' %>>Suspended</option>
                  </select>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Role</label>
                  <select class="form-control" name="roleId">
                    <option value="">No Role</option>
                    <% (roles || []).forEach(function(role) { %>
                    <option value="<%= role.roleId %>" <%= adminUser.roleId === role.roleId ? 'selected' : '' %>>
                      <%= role.name %>
                    </option>
                    <% }); %>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-2"></i>Save Changes
                </button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <!-- Account Stats -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-bar me-2"></i>Account Statistics</h3>
            </div>
            <div class="card-body">
              <table class="table table-borderless">
                <tr>
                  <th>User ID</th>
                  <td><code><%= adminUser.userId %></code></td>
                </tr>
                <tr>
                  <th>Created</th>
                  <td><%= new Date(adminUser.createdAt).toLocaleString() %></td>
                </tr>
                <tr>
                  <th>Last Login</th>
                  <td><%= adminUser.lastLoginAt ? new Date(adminUser.lastLoginAt).toLocaleString() : 'Never' %></td>
                </tr>
                <tr>
                  <th>Login Count</th>
                  <td><%= adminUser.loginCount || 0 %></td>
                </tr>
                <tr>
                  <th>Email Verified</th>
                  <td>
                    <span class="badge bg-<%= adminUser.emailVerified ? 'success' : 'warning' %>">
                      <%= adminUser.emailVerified ? 'Yes' : 'No' %>
                    </span>
                  </td>
                </tr>
                <tr>
                  <th>MFA Enabled</th>
                  <td>
                    <span class="badge bg-<%= adminUser.mfaEnabled ? 'success' : 'secondary' %>">
                      <%= adminUser.mfaEnabled ? 'Yes' : 'No' %>
                    </span>
                  </td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Permissions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-shield-alt me-2"></i>Permissions</h3>
            </div>
            <div class="card-body">
              <% if ((permissions || []).length > 0) { %>
                <% permissions.forEach(function(perm) { %>
                  <span class="badge bg-info me-1 mb-1"><%= perm %></span>
                <% }); %>
              <% } else { %>
                <p class="text-muted mb-0">No permissions assigned. Assign a role to grant permissions.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="row">
        <div class="col-12">
          <a href="/hub/users" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Users
          </a>
          <button class="btn btn-danger float-end" onclick="deleteUser()">
            <i class="fas fa-trash me-2"></i>Delete User
          </button>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  document.getElementById('updateUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('/hub/users/<%= adminUser.userId %>', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      if (result.success) {
        alert('User updated successfully');
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  });

  async function deleteUser() {
    if (!confirm('Are you sure you want to delete this user?')) return;

    try {
      const response = await fetch('/hub/users/<%= adminUser.userId %>', { method: 'DELETE' });
      const result = await response.json();
      if (result.success) {
        window.location.href = '/hub/users';
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }
</script>

<%- include('../partials/footer') %>
