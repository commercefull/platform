<%- include('../partials/header', { title: pageName }) %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-shield-alt me-2"></i><%= pageName %></h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="/hub">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/hub/users">Admin Users</a></li>
            <li class="breadcrumb-item active">Roles</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <!-- Create Role Button -->
      <div class="row mb-3">
        <div class="col-12">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
            <i class="fas fa-plus me-2"></i>Create Role
          </button>
        </div>
      </div>

      <!-- Roles List -->
      <div class="row">
        <% (roles || []).forEach(function(role) { %>
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-user-shield me-2"></i><%= role.name %>
                <% if (role.isSystem) { %>
                  <span class="badge bg-secondary ms-2">System</span>
                <% } %>
              </h3>
              <span class="float-end text-muted"><%= role.userCount || 0 %> users</span>
            </div>
            <div class="card-body">
              <% if (role.description) { %>
                <p class="text-muted"><%= role.description %></p>
              <% } %>
              <h6>Permissions:</h6>
              <div class="mb-3">
                <% const perms = typeof role.permissions === 'string' ? JSON.parse(role.permissions) : (role.permissions || []); %>
                <% if (perms.length > 0) { %>
                  <% perms.forEach(function(perm) { %>
                    <span class="badge bg-info me-1 mb-1"><%= perm %></span>
                  <% }); %>
                <% } else { %>
                  <span class="text-muted">No permissions</span>
                <% } %>
              </div>
              <% if (!role.isSystem) { %>
              <button class="btn btn-sm btn-outline-primary" onclick="editRole('<%= role.roleId %>', '<%= role.name %>', '<%= role.description || '' %>', '<%= JSON.stringify(perms) %>')">
                <i class="fas fa-edit me-1"></i>Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRole('<%= role.roleId %>')">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
              <% } %>
            </div>
          </div>
        </div>
        <% }); %>
        <% if ((roles || []).length === 0) { %>
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center text-muted">
              No roles defined. Click "Create Role" to add one.
            </div>
          </div>
        </div>
        <% } %>
      </div>

      <!-- Available Permissions Reference -->
      <div class="row">
        <div class="col-12">
          <div class="card collapsed-card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-list me-2"></i>Available Permissions</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <% 
                  const categories = {};
                  (availablePermissions || []).forEach(function(perm) {
                    if (!categories[perm.category]) categories[perm.category] = [];
                    categories[perm.category].push(perm);
                  });
                %>
                <% Object.entries(categories).forEach(function([category, perms]) { %>
                <div class="col-md-4 mb-3">
                  <h6><%= category %></h6>
                  <% perms.forEach(function(perm) { %>
                    <div><code><%= perm.key %></code> - <%= perm.name %></div>
                  <% }); %>
                </div>
                <% }); %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="createRoleForm">
          <div class="mb-3">
            <label class="form-label">Role Name</label>
            <input type="text" class="form-control" name="name" required placeholder="e.g., Editor">
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="2" placeholder="Optional description"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Permissions</label>
            <div class="row" style="max-height: 300px; overflow-y: auto;">
              <% Object.entries(categories).forEach(function([category, perms]) { %>
              <div class="col-md-6 mb-3">
                <h6><%= category %></h6>
                <% perms.forEach(function(perm) { %>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="permissions" value="<%= perm.key %>" id="perm_<%= perm.key.replace(/\./g, '_') %>">
                  <label class="form-check-label" for="perm_<%= perm.key.replace(/\./g, '_') %>">
                    <%= perm.name %>
                  </label>
                </div>
                <% }); %>
              </div>
              <% }); %>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createRole()">Create Role</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editRoleForm">
          <input type="hidden" name="roleId" id="editRoleId">
          <div class="mb-3">
            <label class="form-label">Role Name</label>
            <input type="text" class="form-control" name="name" id="editRoleName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" id="editRoleDescription" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Permissions</label>
            <div class="row" style="max-height: 300px; overflow-y: auto;">
              <% Object.entries(categories).forEach(function([category, perms]) { %>
              <div class="col-md-6 mb-3">
                <h6><%= category %></h6>
                <% perms.forEach(function(perm) { %>
                <div class="form-check">
                  <input class="form-check-input edit-perm" type="checkbox" name="permissions" value="<%= perm.key %>" id="edit_perm_<%= perm.key.replace(/\./g, '_') %>">
                  <label class="form-check-label" for="edit_perm_<%= perm.key.replace(/\./g, '_') %>">
                    <%= perm.name %>
                  </label>
                </div>
                <% }); %>
              </div>
              <% }); %>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveRole()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  async function createRole() {
    const form = document.getElementById('createRoleForm');
    const formData = new FormData(form);
    
    const data = {
      name: formData.get('name'),
      description: formData.get('description'),
      permissions: formData.getAll('permissions')
    };

    try {
      const response = await fetch('/hub/roles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function editRole(roleId, name, description, permissionsJson) {
    document.getElementById('editRoleId').value = roleId;
    document.getElementById('editRoleName').value = name;
    document.getElementById('editRoleDescription').value = description;
    
    // Clear all checkboxes
    document.querySelectorAll('.edit-perm').forEach(cb => cb.checked = false);
    
    // Check the role's permissions
    const permissions = JSON.parse(permissionsJson);
    permissions.forEach(perm => {
      const cb = document.getElementById('edit_perm_' + perm.replace(/\./g, '_'));
      if (cb) cb.checked = true;
    });
    
    new bootstrap.Modal(document.getElementById('editRoleModal')).show();
  }

  async function saveRole() {
    const form = document.getElementById('editRoleForm');
    const formData = new FormData(form);
    const roleId = formData.get('roleId');
    
    const data = {
      name: formData.get('name'),
      description: formData.get('description'),
      permissions: formData.getAll('permissions')
    };

    try {
      const response = await fetch(`/hub/roles/${roleId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function deleteRole(roleId) {
    if (!confirm('Are you sure you want to delete this role?')) return;

    try {
      const response = await fetch(`/hub/roles/${roleId}`, { method: 'DELETE' });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }
</script>

<%- include('../partials/footer') %>
