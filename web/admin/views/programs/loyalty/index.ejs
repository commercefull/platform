<%- include('../../partials/header', { title: pageName }) %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-star me-2"></i><%= pageName %></h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
            <li class="breadcrumb-item active">Loyalty Program</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <!-- Stats -->
      <div class="row">
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3><%= stats.totalMembers || 0 %></h3>
              <p>Program Members</p>
            </div>
            <div class="icon"><i class="fas fa-users"></i></div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3><%= (stats.totalPointsIssued || 0).toLocaleString() %></h3>
              <p>Points Issued</p>
            </div>
            <div class="icon"><i class="fas fa-coins"></i></div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3><%= (stats.totalPointsRedeemed || 0).toLocaleString() %></h3>
              <p>Points Redeemed</p>
            </div>
            <div class="icon"><i class="fas fa-gift"></i></div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-danger">
            <div class="inner">
              <h3><%= (rewards || []).length %></h3>
              <p>Available Rewards</p>
            </div>
            <div class="icon"><i class="fas fa-trophy"></i></div>
          </div>
        </div>
      </div>

      <!-- Program Settings -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-cog me-2"></i>Program Settings</h3>
        </div>
        <div class="card-body">
          <form method="POST" action="/admin/programs/loyalty/settings">
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Points per Dollar Spent</label>
                  <input type="number" class="form-control" name="pointsPerDollar" value="<%= settings.pointsPerDollar || 1 %>" min="0" step="0.1">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Points Value ($ per point)</label>
                  <input type="number" class="form-control" name="pointValue" value="<%= settings.pointValue || 0.01 %>" min="0" step="0.001">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Minimum Redemption</label>
                  <input type="number" class="form-control" name="minRedemption" value="<%= settings.minRedemption || 100 %>" min="0">
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </form>
        </div>
      </div>

      <!-- Rewards -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-gift me-2"></i>Rewards</h3>
          <button class="btn btn-sm btn-success float-end" data-bs-toggle="modal" data-bs-target="#addRewardModal">
            <i class="fas fa-plus me-1"></i>Add Reward
          </button>
        </div>
        <div class="card-body table-responsive p-0">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Reward</th>
                <th>Points Required</th>
                <th>Type</th>
                <th>Redemptions</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% (rewards || []).forEach(function(reward) { %>
              <tr>
                <td>
                  <strong><%= reward.name %></strong>
                  <br><small class="text-muted"><%= reward.description || '' %></small>
                </td>
                <td><%= (reward.pointsCost || 0).toLocaleString() %> pts</td>
                <td><span class="badge bg-secondary"><%= reward.rewardType || 'discount' %></span></td>
                <td><%= reward.redemptionCount || 0 %></td>
                <td>
                  <span class="badge bg-<%= reward.isActive ? 'success' : 'secondary' %>">
                    <%= reward.isActive ? 'Active' : 'Inactive' %>
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="editReward('<%= reward.rewardId %>')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteReward('<%= reward.rewardId %>')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              <% }); %>
              <% if ((rewards || []).length === 0) { %>
              <tr>
                <td colspan="6" class="text-center text-muted py-4">No rewards configured.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-history me-2"></i>Recent Transactions</h3>
          <a href="/admin/programs/loyalty/transactions" class="btn btn-sm btn-primary float-end">View All</a>
        </div>
        <div class="card-body table-responsive p-0">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Type</th>
                <th>Points</th>
                <th>Description</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <% (transactions || []).slice(0, 10).forEach(function(tx) { %>
              <tr>
                <td><%= tx.customerName || tx.email %></td>
                <td>
                  <span class="badge bg-<%= tx.type === 'earn' ? 'success' : tx.type === 'redeem' ? 'warning' : 'info' %>">
                    <%= tx.type %>
                  </span>
                </td>
                <td class="<%= tx.type === 'earn' ? 'text-success' : 'text-danger' %>">
                  <%= tx.type === 'earn' ? '+' : '-' %><%= Math.abs(tx.points).toLocaleString() %>
                </td>
                <td><%= tx.description || '-' %></td>
                <td><%= new Date(tx.createdAt).toLocaleDateString() %></td>
              </tr>
              <% }); %>
              <% if ((transactions || []).length === 0) { %>
              <tr>
                <td colspan="5" class="text-center text-muted py-4">No transactions yet.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Add Reward Modal -->
<div class="modal fade" id="addRewardModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Reward</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/admin/programs/loyalty/rewards">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Reward Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Points Required <span class="text-danger">*</span></label>
                <input type="number" class="form-control" name="pointsCost" min="1" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Reward Type</label>
                <select class="form-select" name="rewardType">
                  <option value="discount">Discount</option>
                  <option value="free_shipping">Free Shipping</option>
                  <option value="free_product">Free Product</option>
                  <option value="gift_card">Gift Card</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Reward Value</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" name="value" step="0.01" min="0">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="2"></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isActive" value="true" id="rewardIsActive" checked>
            <label class="form-check-label" for="rewardIsActive">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Reward</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function editReward(id) { window.location.href = `/admin/programs/loyalty/rewards/${id}/edit`; }
  async function deleteReward(id) {
    if (!confirm('Delete this reward?')) return;
    const res = await fetch(`/admin/programs/loyalty/rewards/${id}`, { method: 'DELETE' });
    if ((await res.json()).success) location.reload();
  }
</script>

<%- include('../../partials/footer') %>
