<%- include('../partials/header', { title: pageName }) %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-edit me-2"></i><%= pageName %></h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/admin/products">Products</a></li>
            <li class="breadcrumb-item active">Edit</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible">
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <i class="fas fa-exclamation-triangle me-2"></i><%= error %>
      </div>
      <% } %>

      <form method="POST" action="/admin/products/<%= product.productId %>" enctype="multipart/form-data">
        <div class="row">
          <!-- Main Content -->
          <div class="col-lg-8">
            <!-- Basic Info -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-info-circle me-2"></i>Basic Information</h3>
              </div>
              <div class="card-body">
                <div class="form-group mb-3">
                  <label class="form-label">Product Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="name" value="<%= product.name || '' %>" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">SKU</label>
                      <input type="text" class="form-control" name="sku" value="<%= product.sku || '' %>">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Slug</label>
                      <input type="text" class="form-control" name="slug" value="<%= product.slug || '' %>">
                    </div>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Short Description</label>
                  <textarea class="form-control" name="shortDescription" rows="2"><%= product.shortDescription || '' %></textarea>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Full Description</label>
                  <textarea class="form-control" name="description" rows="5"><%= product.description || '' %></textarea>
                </div>
              </div>
            </div>

            <!-- Pricing -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-dollar-sign me-2"></i>Pricing</h3>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Base Price <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" name="basePrice" value="<%= product.basePrice || 0 %>" step="0.01" min="0" required>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Sale Price</label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" name="salePrice" value="<%= product.salePrice || '' %>" step="0.01" min="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Cost</label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" name="cost" value="<%= product.cost || '' %>" step="0.01" min="0">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dimensions -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-ruler-combined me-2"></i>Dimensions & Weight</h3>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Weight</label>
                      <div class="input-group">
                        <input type="number" class="form-control" name="weight" value="<%= product.weight || '' %>" step="0.01" min="0">
                        <select class="form-select" name="weightUnit" style="max-width: 100px;">
                          <option value="kg" <%= product.weightUnit === 'kg' ? 'selected' : '' %>>kg</option>
                          <option value="lb" <%= product.weightUnit === 'lb' ? 'selected' : '' %>>lb</option>
                          <option value="g" <%= product.weightUnit === 'g' ? 'selected' : '' %>>g</option>
                          <option value="oz" <%= product.weightUnit === 'oz' ? 'selected' : '' %>>oz</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Length</label>
                      <input type="number" class="form-control" name="length" value="<%= product.length || '' %>" step="0.01" min="0">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Width</label>
                      <input type="number" class="form-control" name="width" value="<%= product.width || '' %>" step="0.01" min="0">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Height</label>
                      <div class="input-group">
                        <input type="number" class="form-control" name="height" value="<%= product.height || '' %>" step="0.01" min="0">
                        <select class="form-select" name="dimensionUnit" style="max-width: 80px;">
                          <option value="cm" <%= product.dimensionUnit === 'cm' ? 'selected' : '' %>>cm</option>
                          <option value="in" <%= product.dimensionUnit === 'in' ? 'selected' : '' %>>in</option>
                          <option value="m" <%= product.dimensionUnit === 'm' ? 'selected' : '' %>>m</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SEO -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-search me-2"></i>SEO</h3>
              </div>
              <div class="card-body">
                <div class="form-group mb-3">
                  <label class="form-label">Meta Title</label>
                  <input type="text" class="form-control" name="metaTitle" value="<%= product.metaTitle || '' %>" maxlength="70">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Meta Description</label>
                  <textarea class="form-control" name="metaDescription" rows="2" maxlength="160"><%= product.metaDescription || '' %></textarea>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Meta Keywords</label>
                  <input type="text" class="form-control" name="metaKeywords" value="<%= product.metaKeywords || '' %>">
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="col-lg-4">
            <!-- Publish -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-paper-plane me-2"></i>Publish</h3>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                  <span>Status:</span>
                  <span class="badge bg-<%= product.status === 'active' ? 'success' : product.status === 'draft' ? 'warning' : 'secondary' %>">
                    <%= product.status %>
                  </span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                  <span>Visibility:</span>
                  <span class="badge bg-info"><%= product.visibility %></span>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="status">
                    <option value="draft" <%= product.status === 'draft' ? 'selected' : '' %>>Draft</option>
                    <option value="active" <%= product.status === 'active' ? 'selected' : '' %>>Active</option>
                    <option value="inactive" <%= product.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                    <option value="archived" <%= product.status === 'archived' ? 'selected' : '' %>>Archived</option>
                  </select>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Visibility</label>
                  <select class="form-select" name="visibility">
                    <option value="visible" <%= product.visibility === 'visible' ? 'selected' : '' %>>Visible</option>
                    <option value="hidden" <%= product.visibility === 'hidden' ? 'selected' : '' %>>Hidden</option>
                    <option value="catalog" <%= product.visibility === 'catalog' ? 'selected' : '' %>>Catalog Only</option>
                    <option value="search" <%= product.visibility === 'search' ? 'selected' : '' %>>Search Only</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100 mb-2">
                  <i class="fas fa-save me-2"></i>Save Changes
                </button>
                <a href="/admin/products/<%= product.productId %>" class="btn btn-secondary w-100">
                  <i class="fas fa-times me-2"></i>Cancel
                </a>
              </div>
            </div>

            <!-- Organization -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-folder me-2"></i>Organization</h3>
              </div>
              <div class="card-body">
                <div class="form-group mb-3">
                  <label class="form-label">Product Type</label>
                  <select class="form-select" name="productTypeId">
                    <option value="">Select Type</option>
                    <% (productTypes || []).forEach(function(type) { %>
                    <option value="<%= type.productTypeId %>" <%= product.productTypeId === type.productTypeId ? 'selected' : '' %>><%= type.name %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Category</label>
                  <select class="form-select" name="categoryId">
                    <option value="">Select Category</option>
                    <% (categories || []).forEach(function(cat) { %>
                    <option value="<%= cat.categoryId %>" <%= product.categoryId === cat.categoryId ? 'selected' : '' %>><%= cat.name %></option>
                    <% }); %>
                  </select>
                </div>
              </div>
            </div>

            <!-- Options -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-cog me-2"></i>Options</h3>
              </div>
              <div class="card-body">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="isFeatured" value="true" id="isFeatured" <%= product.isFeatured ? 'checked' : '' %>>
                  <label class="form-check-label" for="isFeatured">Featured Product</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="isTaxable" value="true" id="isTaxable" <%= product.isTaxable !== false ? 'checked' : '' %>>
                  <label class="form-check-label" for="isTaxable">Taxable</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="isVirtual" value="true" id="isVirtual" <%= product.isVirtual ? 'checked' : '' %>>
                  <label class="form-check-label" for="isVirtual">Virtual Product</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="isDownloadable" value="true" id="isDownloadable" <%= product.isDownloadable ? 'checked' : '' %>>
                  <label class="form-check-label" for="isDownloadable">Downloadable</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="isSubscription" value="true" id="isSubscription" <%= product.isSubscription ? 'checked' : '' %>>
                  <label class="form-check-label" for="isSubscription">Subscription Product</label>
                </div>
              </div>
            </div>

            <!-- Danger Zone -->
            <div class="card card-danger">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h3>
              </div>
              <div class="card-body">
                <button type="button" class="btn btn-outline-danger w-100" onclick="deleteProduct()">
                  <i class="fas fa-trash me-2"></i>Delete Product
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>
</div>

<script>
  async function deleteProduct() {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) return;

    try {
      const response = await fetch('/admin/products/<%= product.productId %>', { method: 'DELETE' });
      const result = await response.json();
      if (result.success) {
        window.location.href = '/admin/products?success=Product deleted successfully';
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }
</script>

<%- include('../partials/footer') %>
