<!-- Page Header -->
<div class="page-header d-print-none pb-3">
  <div class="row g-2 align-items-center">
    <div class="col">
      <h2 class="page-title">
        Promotions
      </h2>
    </div>
    <div class="col-auto">
      <a href="/admin/promotions/create" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M12 5v14" />
          <path d="M5 12h14" />
        </svg>
        Create Promotion
      </a>
    </div>
  </div>
</div>

<!-- Main content -->
<section class="content">
  <%- include("../partials/alerts") %>

  <!-- Filters -->
  <div class="card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="card-title mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 6h16" />
              <path d="M4 12h16" />
              <path d="M4 18h12" />
            </svg>
            Filters
          </h3>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFilters">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
            </svg>
            Show Filters
          </button>
        </div>
      </div>
    </div>
    <div class="card-body" id="filtersBody" style="display: none;">
      <form method="GET" class="row g-3">
        <!-- Status -->
        <div class="col-md-6 col-lg-4">
          <label class="form-label" for="status">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M9 12l2 2l4 -4" />
            </svg>
            Status
          </label>
          <select class="form-select" name="status" id="status">
            <option value="">All Status</option>
            <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active</option>
            <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
            <option value="expired" <%= filters.status === 'expired' ? 'selected' : '' %>>Expired</option>
          </select>
        </div>

        <!-- Type -->
        <div class="col-md-6 col-lg-4">
          <label class="form-label" for="type">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M9 12l2 2l4 -4" />
            </svg>
            Type
          </label>
          <select class="form-select" name="type" id="type">
            <option value="">All Types</option>
            <option value="percentage" <%= filters.type === 'percentage' ? 'selected' : '' %>>Percentage</option>
            <option value="fixed_amount" <%= filters.type === 'fixed_amount' ? 'selected' : '' %>>Fixed Amount</option>
            <option value="free_shipping" <%= filters.type === 'free_shipping' ? 'selected' : '' %>>Free Shipping</option>
          </select>
        </div>

        <!-- Search -->
        <div class="col-md-6 col-lg-4">
          <label class="form-label" for="search">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
              <path d="M21 21l-6 -6" />
            </svg>
            Search
          </label>
          <input type="text" class="form-control" name="search" id="search" placeholder="Code or name..." value="<%= filters.search %>">
        </div>

        <!-- Actions -->
        <div class="col-12">
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                <path d="M21 21l-6 -6" />
              </svg>
              Apply Filters
            </button>
            <a href="/admin/promotions" class="btn btn-outline-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M19 19h-11l-4 -4a2 2 0 0 1 0 -2.828l4 -4h11a2 2 0 0 0 2 -2v-3a2 2 0 0 0 -2 -2h-3l-3 -3" />
                <path d="M3 3l18 18" />
              </svg>
              Clear All
            </a>
            <% if (filters.search || filters.status || filters.type) { %>
            <div class="ms-auto">
              <span class="badge bg-info">
                <%= [filters.search && 'Search', filters.status && 'Status', filters.type && 'Type'].filter(Boolean).join(' + ') %> filters active
              </span>
            </div>
            <% } %>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Promotions Table -->
  <div class="card">
    <div class="card-header">
      <div class="col">
        <h3 class="card-title mb-0">Promotions (<%= pagination.total %>)</h3>
      </div>
    </div>
    <div class="card-body table-responsive p-0">
      <table class="table table-hover text-nowrap">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Type</th>
            <th>Discount</th>
            <th>Usage</th>
            <th>Valid Until</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (promotions.length === 0) { %>
          <tr>
            <td colspan="8" class="text-center py-4">
              <em>No promotions found. <a href="/admin/promotions/create">Create your first promotion</a>.</em>
            </td>
          </tr>
          <% } else { %>
          <% promotions.forEach(promotion => { %>
          <tr>
            <td>
              <code><%= promotion.code %></code>
            </td>
            <td>
              <strong><%= promotion.name %></strong>
              <% if (promotion.description) { %>
              <br><small class="text-muted"><%= promotion.description %></small>
              <% } %>
            </td>
            <td>
              <span class="badge badge-secondary"><%= promotion.type.replace('_', ' ') %></span>
            </td>
            <td>
              <% if (promotion.type === 'percentage') { %>
              <%= promotion.value %>% off
              <% } else if (promotion.type === 'fixed_amount') { %>
              $<%= promotion.value.toFixed(2) %>
              <% } else { %>
              Free Shipping
              <% } %>
            </td>
            <td>
              <%= promotion.usageCount || 0 %>
              <% if (promotion.maxUsage) { %>
              / <%= promotion.maxUsage %>
              <% } %>
            </td>
            <td>
              <% if (promotion.endDate) { %>
              <%= new Date(promotion.endDate).toLocaleDateString() %>
              <% } else { %>
              <em>No expiry</em>
              <% } %>
            </td>
            <td>
              <span class="badge badge-<%= promotion.status === 'active' ? 'success' : promotion.status === 'expired' ? 'warning' : 'secondary' %>">
                <%= promotion.status %>
              </span>
            </td>
            <td>
              <div class="btn-group">
                <a href="/admin/promotions/<%= promotion.promotionId %>" class="btn btn-sm btn-info" title="View">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="/admin/promotions/<%= promotion.promotionId %>/edit" class="btn btn-sm btn-primary" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <button class="btn btn-sm btn-danger" onclick="deletePromotion('<%= promotion.promotionId %>', '<%= promotion.name %>')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <% }); %>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <% if (pagination.pages > 1) { %>
    <div class="card-footer">
      <nav>
        <ul class="pagination pagination-sm m-0">
          <% for (let i = 1; i <= pagination.pages; i++) { %>
          <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>&status=<%= filters.status %>&type=<%= filters.type %>&search=<%= filters.search %>"><%= i %></a>
          </li>
          <% } %>
        </ul>
      </nav>
    </div>
    <% } %>
  </div>
</section>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Delete Promotion</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the promotion "<strong id="deletePromotionName"></strong>"?</p>
        <p class="text-danger"><small>This action cannot be undone.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Promotion</button>
      </div>
    </div>
  </div>
</div>

<script src="/javascripts/admin/promotions.js"></script>