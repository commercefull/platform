<%- include('../partials/header', { title: pageName }) %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-language me-2"></i><%= pageName %></h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
            <li class="breadcrumb-item active">Localization</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <!-- Languages -->
      <div class="row">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-globe me-2"></i>Languages</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-bs-toggle="modal" data-bs-target="#addLanguageModal">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body table-responsive p-0">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% (languages || []).forEach(function(lang) { %>
                  <tr>
                    <td><code><%= lang.code %></code></td>
                    <td>
                      <%= lang.name %>
                      <% if (lang.isDefault) { %>
                        <span class="badge bg-primary ms-1">Default</span>
                      <% } %>
                    </td>
                    <td>
                      <span class="badge bg-<%= lang.isActive ? 'success' : 'secondary' %>">
                        <%= lang.isActive ? 'Active' : 'Inactive' %>
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick="editLanguage('<%= lang.languageId %>', '<%= lang.code %>', '<%= lang.name %>', <%= lang.isDefault %>, <%= lang.isActive %>)">
                        <i class="fas fa-edit"></i>
                      </button>
                      <% if (!lang.isDefault) { %>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteLanguage('<%= lang.languageId %>')">
                        <i class="fas fa-trash"></i>
                      </button>
                      <% } %>
                    </td>
                  </tr>
                  <% }); %>
                  <% if ((languages || []).length === 0) { %>
                  <tr>
                    <td colspan="4" class="text-center text-muted">No languages configured</td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Currencies -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-dollar-sign me-2"></i>Currencies</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-bs-toggle="modal" data-bs-target="#addCurrencyModal">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body table-responsive p-0">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Rate</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% (currencies || []).forEach(function(curr) { %>
                  <tr>
                    <td>
                      <code><%= curr.code %></code>
                      <span class="ms-1"><%= curr.symbol %></span>
                    </td>
                    <td>
                      <%= curr.name %>
                      <% if (curr.isDefault) { %>
                        <span class="badge bg-primary ms-1">Default</span>
                      <% } %>
                    </td>
                    <td><%= curr.exchangeRate %></td>
                    <td>
                      <span class="badge bg-<%= curr.isActive ? 'success' : 'secondary' %>">
                        <%= curr.isActive ? 'Active' : 'Inactive' %>
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick="editCurrency('<%= curr.currencyId %>', '<%= curr.code %>', '<%= curr.name %>', '<%= curr.symbol %>', <%= curr.exchangeRate %>, <%= curr.isDefault %>, <%= curr.isActive %>)">
                        <i class="fas fa-edit"></i>
                      </button>
                      <% if (!curr.isDefault) { %>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrency('<%= curr.currencyId %>')">
                        <i class="fas fa-trash"></i>
                      </button>
                      <% } %>
                    </td>
                  </tr>
                  <% }); %>
                  <% if ((currencies || []).length === 0) { %>
                  <tr>
                    <td colspan="5" class="text-center text-muted">No currencies configured</td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Countries -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-flag me-2"></i>Countries</h3>
            </div>
            <div class="card-body">
              <div class="row">
                <% (countries || []).slice(0, 12).forEach(function(country) { %>
                <div class="col-md-2 col-sm-4 mb-2">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-<%= country.isActive ? 'success' : 'secondary' %> me-2">
                      <%= country.code %>
                    </span>
                    <span><%= country.name %></span>
                  </div>
                </div>
                <% }); %>
              </div>
              <% if ((countries || []).length > 12) { %>
              <p class="text-muted mb-0">...and <%= countries.length - 12 %> more countries</p>
              <% } %>
              <% if ((countries || []).length === 0) { %>
              <p class="text-muted mb-0">No countries configured</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Add Language Modal -->
<div class="modal fade" id="addLanguageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Language</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addLanguageForm">
          <div class="mb-3">
            <label class="form-label">Language Code</label>
            <input type="text" class="form-control" name="code" required placeholder="e.g., en, es, fr">
          </div>
          <div class="mb-3">
            <label class="form-label">Language Name</label>
            <input type="text" class="form-control" name="name" required placeholder="e.g., English">
          </div>
          <div class="mb-3">
            <label class="form-label">Native Name</label>
            <input type="text" class="form-control" name="nativeName" placeholder="e.g., English">
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="isDefault" id="langIsDefault">
            <label class="form-check-label" for="langIsDefault">Set as default</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isActive" id="langIsActive" checked>
            <label class="form-check-label" for="langIsActive">Active</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addLanguage()">Add Language</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Currency Modal -->
<div class="modal fade" id="addCurrencyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Currency</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addCurrencyForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Currency Code</label>
                <input type="text" class="form-control" name="code" required placeholder="e.g., USD, EUR">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Symbol</label>
                <input type="text" class="form-control" name="symbol" placeholder="e.g., $, â‚¬">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Currency Name</label>
            <input type="text" class="form-control" name="name" required placeholder="e.g., US Dollar">
          </div>
          <div class="mb-3">
            <label class="form-label">Exchange Rate</label>
            <input type="number" class="form-control" name="exchangeRate" step="0.0001" value="1" placeholder="1.0000">
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="isDefault" id="currIsDefault">
            <label class="form-check-label" for="currIsDefault">Set as default</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isActive" id="currIsActive" checked>
            <label class="form-check-label" for="currIsActive">Active</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addCurrency()">Add Currency</button>
      </div>
    </div>
  </div>
</div>

<script>
  async function addLanguage() {
    const form = document.getElementById('addLanguageForm');
    const formData = new FormData(form);
    const data = {
      code: formData.get('code'),
      name: formData.get('name'),
      nativeName: formData.get('nativeName'),
      isDefault: formData.get('isDefault') === 'on',
      isActive: formData.get('isActive') === 'on'
    };

    try {
      const response = await fetch('/admin/settings/languages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function deleteLanguage(languageId) {
    if (!confirm('Are you sure you want to delete this language?')) return;

    try {
      const response = await fetch(`/admin/settings/languages/${languageId}`, { method: 'DELETE' });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function addCurrency() {
    const form = document.getElementById('addCurrencyForm');
    const formData = new FormData(form);
    const data = {
      code: formData.get('code'),
      name: formData.get('name'),
      symbol: formData.get('symbol'),
      exchangeRate: parseFloat(formData.get('exchangeRate')) || 1,
      isDefault: formData.get('isDefault') === 'on',
      isActive: formData.get('isActive') === 'on'
    };

    try {
      const response = await fetch('/admin/settings/currencies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function deleteCurrency(currencyId) {
    if (!confirm('Are you sure you want to delete this currency?')) return;

    try {
      const response = await fetch(`/admin/settings/currencies/${currencyId}`, { method: 'DELETE' });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function editLanguage(id, code, name, isDefault, isActive) {
    alert('Edit language functionality - would open modal with: ' + code + ' - ' + name);
  }

  function editCurrency(id, code, name, symbol, rate, isDefault, isActive) {
    alert('Edit currency functionality - would open modal with: ' + code + ' - ' + name);
  }
</script>

<%- include('../partials/footer') %>
