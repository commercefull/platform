<%- include('../partials/header', { title: pageName }) %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-map-marker-alt me-2"></i><%= pageName %></h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/admin/customers">Customers</a></li>
            <li class="breadcrumb-item"><a href="/admin/customers/<%= customer.customerId %>"><%= customer.firstName %></a></li>
            <li class="breadcrumb-item active">Addresses</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible">
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <i class="fas fa-check-circle me-2"></i><%= success %>
      </div>
      <% } %>

      <div class="row">
        <!-- Addresses List -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-list me-2"></i>Saved Addresses</h3>
              <button class="btn btn-sm btn-success float-end" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                <i class="fas fa-plus me-1"></i>Add Address
              </button>
            </div>
            <div class="card-body">
              <% if ((addresses || []).length === 0) { %>
              <div class="text-center text-muted py-4">
                <i class="fas fa-map-marker-alt fa-3x mb-3 d-block"></i>
                No addresses found for this customer.
              </div>
              <% } else { %>
              <div class="row">
                <% addresses.forEach(function(address) { %>
                <div class="col-md-6 mb-3">
                  <div class="card h-100 <%= address.isDefault ? 'border-primary' : '' %>">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <span>
                        <i class="fas fa-<%= address.addressType === 'billing' ? 'file-invoice' : 'truck' %> me-1"></i>
                        <%= address.addressType === 'billing' ? 'Billing' : 'Shipping' %>
                      </span>
                      <% if (address.isDefault) { %>
                      <span class="badge bg-primary">Default</span>
                      <% } %>
                    </div>
                    <div class="card-body">
                      <% if (address.firstName || address.lastName) { %>
                      <p class="mb-1"><strong><%= address.firstName %> <%= address.lastName %></strong></p>
                      <% } %>
                      <% if (address.company) { %>
                      <p class="mb-1"><%= address.company %></p>
                      <% } %>
                      <p class="mb-1"><%= address.addressLine1 %></p>
                      <% if (address.addressLine2) { %>
                      <p class="mb-1"><%= address.addressLine2 %></p>
                      <% } %>
                      <p class="mb-1"><%= address.city %>, <%= address.state %> <%= address.postalCode %></p>
                      <p class="mb-1"><%= address.country %></p>
                      <% if (address.phone) { %>
                      <p class="mb-0 text-muted"><i class="fas fa-phone me-1"></i><%= address.phone %></p>
                      <% } %>
                    </div>
                    <div class="card-footer">
                      <button class="btn btn-sm btn-outline-primary" onclick="editAddress('<%= address.addressId %>')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <% if (!address.isDefault) { %>
                      <button class="btn btn-sm btn-outline-success" onclick="setDefaultAddress('<%= address.addressId %>')">
                        <i class="fas fa-star"></i> Set Default
                      </button>
                      <% } %>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress('<%= address.addressId %>')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <% }); %>
              </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-user me-2"></i>Customer</h3>
            </div>
            <div class="card-body">
              <p class="mb-1"><strong><%= customer.firstName %> <%= customer.lastName %></strong></p>
              <p class="mb-1 text-muted"><%= customer.email %></p>
              <% if (customer.phone) { %>
              <p class="mb-0 text-muted"><%= customer.phone %></p>
              <% } %>
            </div>
            <div class="card-footer">
              <a href="/admin/customers/<%= customer.customerId %>" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>Back to Customer
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add New Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/admin/customers/<%= customer.customerId %>/addresses">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="firstName" value="<%= customer.firstName %>">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" name="lastName" value="<%= customer.lastName %>">
              </div>
            </div>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Company</label>
            <input type="text" class="form-control" name="company">
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Address Line 1 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="addressLine1" required>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Address Line 2</label>
            <input type="text" class="form-control" name="addressLine2">
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">City <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="city" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">State/Province <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="state" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">Postal Code <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="postalCode" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">Country <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="country" value="United States" required>
                <input type="hidden" name="countryCode" value="US">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" name="phone">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label">Address Type</label>
                <select class="form-select" name="addressType">
                  <option value="shipping">Shipping</option>
                  <option value="billing">Billing</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isDefault" value="true" id="isDefault">
            <label class="form-check-label" for="isDefault">
              Set as default address
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Address</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function editAddress(addressId) {
    // TODO: Implement edit address modal
    alert('Edit address functionality coming soon');
  }

  async function setDefaultAddress(addressId) {
    try {
      const response = await fetch(`/admin/customers/<%= customer.customerId %>/addresses/${addressId}/default`, {
        method: 'POST'
      });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function deleteAddress(addressId) {
    if (!confirm('Are you sure you want to delete this address?')) return;

    try {
      const response = await fetch(`/admin/customers/<%= customer.customerId %>/addresses/${addressId}`, {
        method: 'DELETE'
      });
      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }
</script>

<%- include('../partials/footer') %>
