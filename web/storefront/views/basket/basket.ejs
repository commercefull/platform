<%- include("../partials/header") %>
<%- include("../partials/categories-navbar") %>
<div class="container cart">
  <% if (basket && basket.items && basket.items.length > 0) { %>
  <div class="row">
    <div class="col-md-11 col-sm-12 m-auto table-responsive">
      <table class="table text-center">
        <thead>
          <tr>
            <th>Product</th>
            <th>&nbsp;</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
            <th>&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          <% basket.items.forEach(item => { %>
          <tr class="my-auto">
            <td>
              <a href="/products/<%=item.categorySlug || 'general'%>/<%=item.productId%>">
                <img src="<%=item.image || '/storefront/images/placeholder.jpg'%>" class="img-small image-fluid" alt="<%=item.name%>" />
              </a>
            </td>
            <td>
              <div class="float-left mb-3">
                <a class="title-link" href="/products/<%=item.categorySlug || 'general'%>/<%=item.productId%>">
                  <h6 class="text-left"><%= item.name %></h6>
                  <p class="text-left">SKU: <%= item.sku || item.productId %></p>
                </a>
              </div>
            </td>
            <td class="text-center">
              <div class="input-group quantity-controls" style="width: 120px; margin: 0 auto;">
                <button class="btn btn-outline-secondary btn-sm" onclick="updateQuantity('<%=item.basketItemId%>', <%=item.quantity - 1%>)">-</button>
                <input type="number" class="form-control text-center" value="<%= item.quantity %>" min="1" readonly>
                <button class="btn btn-outline-secondary btn-sm" onclick="updateQuantity('<%=item.basketItemId%>', <%=item.quantity + 1%>)">+</button>
              </div>
            </td>
            <td>$<%= parseFloat(item.price).toFixed(2) %></td>
            <td>$<%= (parseFloat(item.price) * item.quantity).toFixed(2) %></td>
            <td>
              <button onclick="removeItem('<%=item.basketItemId%>')" class="btn btn-danger btn-sm button-style-danger">
                <i class="fas fa-trash"></i> Remove
              </button>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
  <hr>
  <div class="row mt-4 mr-auto">
    <div class="col-md-11 col-sm-12 m-auto">
      <div class="row">
        <div class="col-md-8"></div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span>Subtotal:</span>
                <span>$<%= basket.totals ? basket.totals.subtotal : '0.00' %></span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Tax:</span>
                <span>$<%= basket.totals ? basket.totals.tax : '0.00' %></span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Shipping:</span>
                <span>$<%= basket.totals ? basket.totals.shipping : '0.00' %></span>
              </div>
              <hr>
              <div class="d-flex justify-content-between font-weight-bold">
                <span>Total:</span>
                <span>$<%= basket.totals ? basket.totals.total : '0.00' %></span>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <a href="/checkout" class="btn btn-primary btn-block button-style">Proceed to Checkout</a>
            <a href="/products" class="btn btn-outline-secondary btn-block mt-2">Continue Shopping</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% } else { %>
  <div class="row text-center">
    <div class="col-md-9 col-sm-9 m-auto">
      <div class="empty-cart">
        <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
        <h2>Your cart is empty</h2>
        <p>Looks like you haven't added anything to your cart yet.</p>
        <a href="/products" class="btn btn-primary button-style mt-3">Start Shopping</a>
      </div>
    </div>
  </div>
  <% } %>
</div>

<script>
async function updateQuantity(basketItemId, newQuantity) {
  if (newQuantity < 1) return;

  try {
    const response = await fetch(`/basket/item/${basketItemId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ quantity: newQuantity })
    });

    if (response.ok) {
      location.reload();
    } else {
      alert('Failed to update quantity');
    }
  } catch (error) {
    console.error('Error updating quantity:', error);
    alert('Failed to update quantity');
  }
}

async function removeItem(basketItemId) {
  if (!confirm('Remove this item from your cart?')) return;

  try {
    const response = await fetch(`/basket/item/${basketItemId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      location.reload();
    } else {
      alert('Failed to remove item');
    }
  } catch (error) {
    console.error('Error removing item:', error);
    alert('Failed to remove item');
  }
}
</script>

<%- include("../partials/footer") %>
